
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نموذج جمع ميداني</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/dexie@4.0.7/dist/dexie.js"></script>
    <script src="https://unpkg.com/pako@2.1.0/dist/pako.min.js"></script>
    <style>
      .loader { border-top-color: #3498db; animation: spin 1s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
      [hidden] { display: none !important; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="max-w-3xl mx-auto p-4 md:p-6 space-y-6">
      
      <!-- Error Display -->
      <div id="error-container" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert" hidden>
        <strong class="font-bold">خطأ!</strong>
        <span class="block sm:inline" id="error-message"></span>
      </div>

      <!-- Main Content (hidden until data is loaded) -->
      <div id="main-content" hidden>
        <!-- Sync Status Header -->
        <div id="sync-status" class="flex items-center justify-between p-3 mb-4 rounded-lg text-sm">
            <div class="flex items-center gap-2">
                <div id="sync-icon"></div>
                <span id="sync-text" class="font-medium"></span>
            </div>
            <div class="flex items-center gap-4">
              <span id="pending-count-container" class="flex items-center gap-1.5" hidden>
                <i data-lucide="upload-cloud" class="w-4 h-4"></i>
                <span><span id="pending-count">0</span> قيد المزامنة</span>
              </span>
              <button id="sync-button" class="px-3 py-1.5 text-xs font-semibold rounded-md flex items-center gap-1.5">
                  <i id="sync-button-icon" data-lucide="refresh-cw" class="w-3.5 h-3.5"></i>
                  <span id="sync-button-text">مزامنة</span>
              </button>
            </div>
        </div>

        <!-- Form Header -->
        <header class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">نموذج جمع ميداني</h1>
                    <p class="text-gray-500">الرجاء تعبئة البيانات التالية بدقة.</p>
                </div>
                <i data-lucide="leaf" class="w-10 h-10 text-green-500"></i>
            </div>
            <div id="plant-info" class="mt-4 pt-4 border-t border-gray-200 space-y-2">
                <!-- Plant info will be rendered here by JS -->
            </div>
        </header>

        <!-- Success Message -->
        <div id="success-message" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert" hidden>
          <strong class="font-bold">تم بنجاح!</strong>
          <span class="block sm:inline">تم حفظ بيانات الجمع محلياً. ستتم المزامنة عند توفر اتصال بالإنترنت.</span>
        </div>

        <!-- Collection Form -->
        <form id="collection-form" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-6">
            <!-- Form fields will be here, matching the Angular form -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium">الكمية</label>
                <input name="quantity" type="number" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
              </div>
              <div>
                  <label class="block text-sm font-medium">الوحدة</label>
                  <select name="unit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                      <option>كيلو</option>
                      <option>جرام</option>
                      <option>وحدة</option>
                  </select>
              </div>
              <div>
                  <label class="block text-sm font-medium">مستوى الجودة</label>
                  <select name="qualityLevel" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                      <option>ممتاز</option>
                      <option>جيد</option>
                      <option>متوسط</option>
                      <option>ضعيف</option>
                  </select>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium">اسم الموقع</label>
                    <input name="locationName" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div class="relative">
                    <label class="block text-sm font-medium">الإحداثيات (GPS)</label>
                    <input name="gpsCoordinates" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
                    <button type="button" id="get-location-btn" class="absolute top-7 left-1 p-1.5 text-gray-500 hover:text-blue-600">
                        <i data-lucide="map-pin" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <div>
                    <label class="block text-sm font-medium">تاريخ الجمع</label>
                    <input name="collectionDate" type="date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div>
                    <label class="block text-sm font-medium">وقت الجمع</label>
                    <input name="collectionTime" type="time" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium">جامع البذور</label>
                <input name="collectorName" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
              </div>
              <div>
                <label class="block text-sm font-medium">الفريق</label>
                <input name="team" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium">ملاحظات عامة</label>
              <textarea name="generalNotes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></textarea>
            </div>

            <div class="flex justify-end">
                <button type="submit" id="save-button" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 flex items-center gap-2">
                  <i data-lucide="save" class="w-5 h-5"></i>
                  <span>حفظ البيانات محلياً</span>
                </button>
            </div>
        </form>
      </div>
    </div>

    <script>
      const SUPABASE_URL = 'https://taodxqtlkyhkupktliwv.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhb2R4cXRsa3loa3Vwa3RsaXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxMDkxMjUsImV4cCI6MjA3NDY4NTEyNX0.3_Lolpx49GZJAai8I5qQRHpD8fXnuOGKJKEhHmXH9Ps';

      // --- Dexie DB Setup ---
      const db = new Dexie('NurseryDB');
      db.version(2).stores({
        offlineCollections: '++id, synced',
      });

      // --- State ---
      let isOnline = navigator.onLine;
      let isSyncing = false;
      let formData = null;

      // --- UI Elements ---
      const app = {
        errorContainer: document.getElementById('error-container'),
        errorMessage: document.getElementById('error-message'),
        mainContent: document.getElementById('main-content'),
        plantInfo: document.getElementById('plant-info'),
        collectionForm: document.getElementById('collection-form'),
        getLocationBtn: document.getElementById('get-location-btn'),
        saveButton: document.getElementById('save-button'),
        successMessage: document.getElementById('success-message'),
        syncStatus: document.getElementById('sync-status'),
        syncIcon: document.getElementById('sync-icon'),
        syncText: document.getElementById('sync-text'),
        syncButton: document.getElementById('sync-button'),
        syncButtonIcon: document.getElementById('sync-button-icon'),
        syncButtonText: document.getElementById('sync-button-text'),
        pendingCountContainer: document.getElementById('pending-count-container'),
        pendingCount: document.getElementById('pending-count'),
      };

      // --- Main Logic ---
      document.addEventListener('DOMContentLoaded', () => {
        try {
          const dataParam = new URLSearchParams(window.location.search).get('data');
          if (!dataParam) throw new Error('لم يتم توفير بيانات في الرابط.');
          formData = decodeData(dataParam);
          renderHeader(formData);
          app.mainContent.hidden = false;
        } catch (e) {
          showError('فشل في فك تشفير بيانات النموذج. قد يكون الرابط غير صالح أو تالف.');
          console.error('Form render error:', e);
        }
        
        lucide.createIcons();
        setupEventListeners();
        updateSyncStatusUI();
        updatePendingCountUI();

        if (isOnline) {
          syncPendingCollections();
        }
      });

      function setupEventListeners() {
        window.addEventListener('online', () => { isOnline = true; updateSyncStatusUI(); syncPendingCollections(); });
        window.addEventListener('offline', () => { isOnline = false; updateSyncStatusUI(); });
        app.collectionForm.addEventListener('submit', saveOffline);
        app.getLocationBtn.addEventListener('click', getOfflineLocation);
        app.syncButton.addEventListener('click', syncPendingCollections);
      }

      function decodeData(encodedString) {
        const base64String = decodeURIComponent(encodedString);
        const binaryString = atob(base64String);
        const compressed = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            compressed[i] = binaryString.charCodeAt(i);
        }
        const jsonString = pako.inflate(compressed, { to: 'string' });
        return JSON.parse(jsonString);
      }
      
      function renderHeader(data) {
        app.plantInfo.innerHTML = `
            <p class="text-sm text-gray-600"><strong>الباركود:</strong> ${data.barcodeId}</p>
            <p class="text-sm text-gray-600"><strong>اسم النبات:</strong> ${data.plantName}</p>
            <p class="text-sm text-gray-600"><strong>الاسم العلمي:</strong> <em>${data.scientificName}</em></p>
        `;
        const form = app.collectionForm.elements;
        form.collectionDate.value = new Date().toISOString().split('T')[0];
        form.collectionTime.value = new Date().toTimeString().split(' ')[0].substring(0, 5);
      }

      async function saveOffline(event) {
        event.preventDefault();
        if (!app.collectionForm.checkValidity()) {
          alert('الرجاء تعبئة جميع الحقول المطلوبة.');
          return;
        }
        
        const formElements = app.collectionForm.elements;
        const dataToSave = {
          ...formData, // from decoded URL
          quantity: formElements.quantity.value,
          unit: formElements.unit.value,
          qualityLevel: formElements.qualityLevel.value,
          locationName: formElements.locationName.value,
          gpsCoordinates: formElements.gpsCoordinates.value,
          collectionDate: formElements.collectionDate.value,
          collectionTime: formElements.collectionTime.value,
          collectorName: formElements.collectorName.value,
          team: formElements.team.value,
          generalNotes: formElements.generalNotes.value,
          collectedAt: new Date().toISOString(),
        };

        try {
          await db.offlineCollections.add({ data: dataToSave, synced: false });
          app.successMessage.hidden = false;
          app.collectionForm.reset();
          renderHeader(formData); // Re-populate default dates
          setTimeout(() => { app.successMessage.hidden = true; }, 3000);
          await updatePendingCountUI();
          if (isOnline) syncPendingCollections();
        } catch (e) {
          showError("فشل حفظ البيانات محلياً. قد تكون مساحة التخزين ممتلئة.");
          console.error("Failed to save to IndexedDB", e);
        }
      }

      function getOfflineLocation() {
        if (!navigator.geolocation) {
          alert('خاصية تحديد الموقع غير مدعومة في هذا المتصفح.');
          return;
        }
        
        app.getLocationBtn.disabled = true;
        app.getLocationBtn.innerHTML = '<div class="loader h-5 w-5 rounded-full border-2 border-gray-200"></div>';

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const { latitude, longitude } = position.coords;
            app.collectionForm.elements.gpsCoordinates.value = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
            app.getLocationBtn.disabled = false;
            app.getLocationBtn.innerHTML = '<i data-lucide="map-pin" class="w-5 h-5"></i>';
            lucide.createIcons();
          },
          (error) => {
            alert('لا يمكن الحصول على الموقع الحالي. يرجى التأكد من تفعيل خدمات الموقع.');
            app.getLocationBtn.disabled = false;
            app.getLocationBtn.innerHTML = '<i data-lucide="map-pin" class="w-5 h-5"></i>';
            lucide.createIcons();
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      }
      
      async function syncPendingCollections() {
          if (!isOnline || isSyncing) return;
          
          isSyncing = true;
          updateSyncStatusUI();

          const unsynced = await db.offlineCollections.where('synced').equals(0).toArray();

          if (unsynced.length === 0) {
              isSyncing = false;
              updateSyncStatusUI();
              return;
          }

          let successCount = 0;
          for (const item of unsynced) {
              const d = item.data;
              const record = {
                  barcode_id: d.barcodeId,
                  plant_id: d.plantId,
                  plant_type: d.plantName,
                  scientific_name: d.scientificName,
                  quantity: d.quantity ? parseFloat(d.quantity) : null,
                  unit: d.unit,
                  quality: d.qualityLevel,
                  collection_date: d.collectionDate,
                  collection_time: d.collectionTime,
                  location: d.locationName,
                  gps_coordinates: d.gpsCoordinates,
                  collector: d.collectorName,
                  team: d.team,
                  notes: d.generalNotes,
                  status: 'قيد المعالجة',
              };

              try {
                  const response = await fetch(`${SUPABASE_URL}/rest/v1/seed_collections`, {
                      method: 'POST',
                      headers: {
                          'apikey': SUPABASE_ANON_KEY,
                          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                          'Content-Type': 'application/json',
                          'Prefer': 'return=minimal'
                      },
                      body: JSON.stringify(record)
                  });

                  if (!response.ok) {
                      throw new Error(`Supabase error: ${response.statusText}`);
                  }
                  
                  await db.offlineCollections.update(item.id, { synced: true });
                  successCount++;

              } catch (error) {
                  console.error('Sync error for item ' + item.id + ':', error);
              }
          }
          console.log(`Successfully synced ${successCount} of ${unsynced.length} records.`);
          isSyncing = false;
          updateSyncStatusUI();
          await updatePendingCountUI();
      }

      function updateSyncStatusUI() {
          if (isSyncing) {
              app.syncStatus.className = 'flex items-center justify-between p-3 mb-4 rounded-lg text-sm bg-blue-100 text-blue-800';
              app.syncIcon.innerHTML = '<div class="loader h-5 w-5 rounded-full border-2 border-blue-200"></div>';
              app.syncText.textContent = 'تجري المزامنة...';
              app.syncButton.disabled = true;
              app.syncButtonIcon.classList.add('animate-spin');
          } else if (isOnline) {
              app.syncStatus.className = 'flex items-center justify-between p-3 mb-4 rounded-lg text-sm bg-green-100 text-green-800';
              app.syncIcon.innerHTML = '<i data-lucide="wifi" class="w-5 h-5"></i>';
              app.syncText.textContent = 'متصل بالإنترنت';
              app.syncButton.disabled = false;
              app.syncButtonIcon.classList.remove('animate-spin');
          } else {
              app.syncStatus.className = 'flex items-center justify-between p-3 mb-4 rounded-lg text-sm bg-yellow-100 text-yellow-800';
              app.syncIcon.innerHTML = '<i data-lucide="wifi-off" class="w-5 h-5"></i>';
              app.syncText.textContent = 'غير متصل بالإنترنت';
              app.syncButton.disabled = true;
              app.syncButtonIcon.classList.remove('animate-spin');
          }
          lucide.createIcons();
      }

      async function updatePendingCountUI() {
          const count = await db.offlineCollections.where('synced').equals(0).count();
          app.pendingCount.textContent = count;
          app.pendingCountContainer.hidden = count === 0;
      }

      function showError(message) {
        app.errorMessage.textContent = message;
        app.errorContainer.hidden = false;
        app.mainContent.hidden = true;
      }
    </script>
</body>
</html>
