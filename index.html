
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>نموذج جمع ميداني</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
  <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
  <style>
    :root {
      --color-bg: #f3f4f6; --color-surface: #ffffff; --color-text: #1f2937;
      --color-text-muted: #6b7280; --color-border: #e5e7eb; --color-primary: #3b82f6;
      --color-primary-hover: #2563eb; --color-green: #16a34a; --color-red: #dc2626;
    }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background-color: var(--color-bg); color: var(--color-text);
      margin: 0; padding: 1rem;
    }
    .container { max-width: 56rem; margin: auto; }
    .card { background-color: var(--color-surface); border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
    .p-6 { padding: 1.5rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    h1 { font-size: 1.5rem; line-height: 2rem; font-weight: 700; }
    h2 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; }
    p { color: var(--color-text-muted); }
    .grid { display: grid; gap: 1rem; }
    .grid-cols-1 { grid-template-columns: 1fr; }
    .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .col-span-2 { grid-column: span 2 / span 2; }
    label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; }
    input[type="text"], input[type="password"], input[type="number"], input[type="date"], input[type="time"], select, textarea {
      width: 100%; box-sizing: border-box; background-color: #f9fafb;
      border: 1px solid var(--color-border); border-radius: 0.5rem;
      padding: 0.625rem; font-size: 0.875rem;
    }
    input[readonly] { background-color: #e5e7eb; cursor: not-allowed; }
    textarea[readonly] { background-color: #e5e7eb; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
      padding: 0.625rem 1rem; font-size: 0.875rem; font-weight: 500;
      border-radius: 0.5rem; border: 1px solid transparent; cursor: pointer; transition: background-color 0.2s;
    }
    .btn-primary { background-color: var(--color-primary); color: white; }
    .btn-primary:hover { background-color: var(--color-primary-hover); }
    .btn-green { background-color: var(--color-green); color: white; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .flex { display: flex; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .justify-end { justify-content: flex-end; }
    .gap-2 { gap: 0.5rem; }
    .hidden { display: none; }
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .font-semibold { font-weight: 600; }
    fieldset { border: none; border-top: 1px solid var(--color-border); padding: 1.5rem 0 0 0; margin-top: 1.5rem; }
    legend { font-size: 1.125rem; font-weight: 600; padding: 0 0.5rem; margin-right: -0.5rem; }
    @media (min-width: 768px) {
      .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .md\:col-span-2 { grid-column: span 2 / span 2; }
    }
  </style>
</head>
<body>
<div class="container">
  <div id="form-container">
    <div class="card mb-6 p-6">
        <h2 class="text-lg font-semibold mb-2">تصدير البيانات للمزامنة</h2>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">عندما تكون مستعدًا للمزامنة، اضغط على الزر أدناه لتوليد نص التصدير. انسخ هذا النص والصقه في صفحة "استيراد بيانات الجمع الميداني" في النظام الرئيسي.</p>
        <div class="space-y-4">
            <button id="exportBtn" class="btn btn-primary">
                <span id="export-icon-wrapper"></span>
                <span id="export-text">تصدير السجلات غير المتزامنة (0)</span>
            </button>
            <div id="export-output-container" class="hidden">
                <textarea id="export-output" readonly style="width: 100%; height: 8rem; font-family: monospace; font-size: 0.75rem;"></textarea>
                <button id="copyBtn" class="btn" style="background-color: #e5e7eb; color: var(--color-text); margin-top: 0.5rem;">نسخ إلى الحافظة</button>
            </div>
        </div>
    </div>
    
    <div class="card p-6">
      <h1>نموذج جمع ميداني</h1>
      <p class="mb-6">قم بتعبئة الحقول التالية ثم اضغط على "حفظ البيانات" لحفظ المعلومات محلياً.</p>
      <form id="collectionForm">
        <fieldset>
          <legend>1. المعلومات الأساسية</legend>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label>رقم الباركود</label><input type="text" id="barcodeId" readonly></div>
            <div><label>نوع النبات</label><input type="text" id="plantName" readonly></div>
            <div><label>الاسم العلمي</label><input type="text" id="scientificName" readonly></div>
            <div><label>تم إنشاؤه بواسطة</label><input type="text" id="userEmail" readonly></div>
          </div>
        </fieldset>

        <fieldset>
            <legend>2. تفاصيل الجمع</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="quantity">الكمية *</label>
                    <div class="flex"><input id="quantity" name="quantity" type="number" value="1" min="0.01" step="0.01" required><select name="unit" id="unit"><option value="kg">كيلو</option><option value="g">جرام</option></select></div>
                </div>
                <div>
                    <label for="qualityLevel">الجودة *</label>
                    <select id="qualityLevel" name="qualityLevel" required><option>ممتاز</option><option>جيد جداً</option><option>جيد</option><option>متوسط</option><option>ضعيف</option></select>
                </div>
                <div><label for="collectionDate">تاريخ الجمع *</label><input id="collectionDate" name="collectionDate" type="date" required></div>
                <div><label for="collectionTime">وقت الجمع *</label><input id="collectionTime" name="collectionTime" type="time" required></div>
            </div>
          </fieldset>
        
          <fieldset>
              <legend>3. معلومات الموقع</legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="locationName">اسم الموقع *</label>
                  <input id="locationName" name="locationName" type="text" required>
                </div>
                <div>
                  <label for="gpsCoordinates">الإحداثيات (GPS)</label>
                  <div class="flex items-center gap-2">
                    <input id="gpsCoordinates" name="gpsCoordinates" type="text" placeholder="46.6753_24.7136">
                    <button type="button" id="getLocationBtn" class="btn btn-primary" style="flex-shrink: 0;">
                      <span id="location-icon-wrapper"></span>
                      <span>الموقع</span>
                    </button>
                  </div>
                </div>
                <div><label for="temperature">درجة الحرارة (مْ)</label><input id="temperature" name="temperature" type="number" step="any"></div>
                <div>
                  <label for="weatherCondition">حالة الطقس</label>
                  <select id="weatherCondition" name="weatherCondition">
                    <option>صافٍ</option><option>مشمس</option><option>غائم جزئياً</option><option>غائم</option><option>ضباب</option><option>مطر خفيف</option><option>مطر</option><option>مطر غزير</option><option>عاصفة رعدية</option><option>ثلج</option><option>مغبر</option>
                  </select>
                </div>
              </div>
          </fieldset>

          <fieldset>
              <legend>4. فريق العمل والمعدات</legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="collectorName">اسم الجامع *</label><input id="collectorName" name="collectorName" type="text" required></div>
                <div><label for="team">الفريق</label><input id="team" name="team" type="text"></div>
                <div><label for="collectionMethod">طريقة الجمع</label><input id="collectionMethod" name="collectionMethod" type="text"></div>
                <div><label for="seedMaturity">درجة نضج البذور</label><input id="seedMaturity" name="seedMaturity" type="text"></div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium mb-2">المعدات المستخدمة</label>
                  <div id="equipment-list" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                </div>
              </div>
          </fieldset>

          <fieldset>
              <legend>5. الملاحظات</legend>
              <div class="grid grid-cols-1 gap-4">
                <div><label for="generalNotes">ملاحظات عامة</label><textarea id="generalNotes" name="generalNotes" rows="3"></textarea></div>
                <div><label for="plantEnvironmentNotes">ملاحظات حول النبات والبيئة</label><textarea id="plantEnvironmentNotes" name="plantEnvironmentNotes" rows="3"></textarea></div>
              </div>
          </fieldset>

        <div class="flex justify-end items-center gap-4" style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--color-border);">
          <div id="status-message-area"></div>
          <button type="submit" id="saveBtn" class="btn btn-green">حفظ البيانات للعمل الميداني</button>
        </div>
      </form>
    </div>
  </div>
  <div id="error-container" class="hidden card p-6 text-center" style="text-align: center;">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin: auto; margin-bottom: 1rem;" class="text-red"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
      <h1 style="margin-bottom: 0.5rem;">خطأ</h1>
      <p id="error-message"></p>
  </div>
</div>

<script>
  // --- INJECTED DATA ---
  const encodedData = 'eJw1zT1uwkAQhuG7bJ1Bs9kde50KgShoKLjB7O4YVvIPsg0Noo0ijpIyp8G3iWM57Tzz6rsrz11oo%2Byj%2BlCb4xZ0TgXl5NBoS%2BpNXSpuhlmdJ2tYI5TGebDOBnAFCmBWEiNqh5b%2FgwPXMiWvn%2FH5%2Bh6%2Fxs8J%2BpCkGVKZwqJtlW4ywbWXbl4onEXKOIN3bSLYwBo8lwKkAwbjSXIXl%2F9dzamakp45rthf%2B7M0Ma1Pf%2BdVaGv1%2BAVXDUSg';
  
  // --- CONFIG ---
  const EQUIPMENT_LIST = [
    { id: 'collection_bags', name: 'أكياس جمع' }, { id: 'pruning_shears', name: 'مقص تقليم' },
    { id: 'ladder', name: 'سلم' }, { id: 'collection_nets', name: 'شباك جمع' },
    { id: 'gloves', name: 'قفازات' }, { id: 'storage_boxes', name: 'صناديق تخزين' },
  ];

  // --- SVG ICONS ---
  const ICONS = {
    spinner: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><line x1="12" x2="12" y1="2" y2="6"/><line x1="12" x2="12" y1="18" y2="22"/><line x1="4.93" x2="7.76" y1="4.93" y2="7.76"/><line x1="16.24" x2="19.07" y1="16.24" y2="19.07"/><line x1="2" x2="6" y1="12" y2="12"/><line x1="18" x2="22" y1="12" y2="12"/><line x1="4.93" x2="7.76" y1="19.07" y2="16.24"/><line x1="16.24" x2="19.07" y1="7.76" y2="4.93"/></svg>',
    export: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>',
    mapPin: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>',
    copy: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>'
  };

  // --- GLOBAL STATE ---
  let baseData = null;
  let db;

  // --- UI ELEMENTS ---
  let form, formContainer, errorContainer, errorMessage, statusMessageArea, getLocationBtn, locationIconWrapper;
  let exportBtn, exportText, exportIcon, exportOutputContainer, exportOutput, copyBtn;
  
  function setStatusMessage(message, type = 'success') {
    const color = type === 'success' ? 'var(--color-green)' : type === 'error' ? 'var(--color-red)' : 'var(--color-text-muted)';
    statusMessageArea.innerHTML = `<span style="color: ${color}; font-weight: 500;">${message}</span>`;
    if (type !== 'info') {
      setTimeout(() => { statusMessageArea.innerHTML = ''; }, 4000);
    }
  }

  function showError(message) {
      formContainer.classList.add('hidden');
      errorContainer.classList.remove('hidden');
      errorMessage.textContent = message;
  }

  function decodeData(encodedString) {
    const base64String = decodeURIComponent(encodedString);
    const binaryString = atob(base64String);
    const compressed = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
        compressed[i] = binaryString.charCodeAt(i);
    }
    const jsonString = pako.inflate(compressed, { to: 'string' });
    return JSON.parse(jsonString);
  }

  async function updatePendingCount() {
    const count = await db.offlineCollections.where('synced').equals(0).count();
    exportText.textContent = `تصدير السجلات غير المتزامنة (${count})`;
    exportBtn.disabled = count === 0;
  }
  
  async function handleExport() {
    exportIcon.innerHTML = ICONS.spinner;
    exportBtn.disabled = true;
    exportOutputContainer.classList.add('hidden');
    
    try {
        const records = await db.offlineCollections.where('synced').equals(0).toArray();
        if (records.length === 0) {
            alert('لا توجد سجلات غير متزامنة لتصديرها.');
            return;
        }
        const jsonString = JSON.stringify(records);
        const compressed = pako.deflate(jsonString);
        let binaryString = '';
        for (let i = 0; i < compressed.length; i++) {
            binaryString += String.fromCharCode(compressed[i]);
        }
        const base64String = btoa(binaryString);
        exportOutput.value = base64String;
        exportOutputContainer.classList.remove('hidden');

    } catch (e) {
        console.error("Export error:", e);
        alert("فشل في تصدير البيانات.");
    } finally {
        exportIcon.innerHTML = ICONS.export;
        updatePendingCount();
    }
  }

  function handleCopy() {
    exportOutput.select();
    document.execCommand('copy');
    alert("تم نسخ البيانات إلى الحافظة!");
  }

  async function handleFormSubmit(event) {
    event.preventDefault();
    if (!form.checkValidity()) {
        alert('الرجاء تعبئة جميع الحقول المطلوبة.');
        return;
    }
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = ICONS.spinner + '<span>جاري الحفظ...</span>';
    
    const formData = new FormData(form);
    const dataToSave = { ...baseData, collectedAt: new Date().toISOString() };
    const equipmentUsed = {};
    for (const [key, value] of formData.entries()) {
       if (key.startsWith('equip-')) {
            const equipId = key.replace('equip-', '');
            equipmentUsed[equipId] = { used: value === 'on' };
       } else {
            dataToSave[key] = value;
       }
    }
    dataToSave['equipmentUsed'] = equipmentUsed;

    try {
      await db.offlineCollections.add({ data: dataToSave, synced: false });
      setStatusMessage('تم الحفظ محلياً بنجاح!', 'success');
      form.reset();
      document.getElementById('collectionDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('collectionTime').value = new Date().toTimeString().split(' ')[0].substring(0,5);
      document.getElementById('quantity').value = '1';
      document.getElementById('unit').value = 'kg';

      await updatePendingCount();
    } catch (e) {
      console.error("Failed to save to IndexedDB", e);
      setStatusMessage("فشل حفظ البيانات محلياً.", 'error');
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = 'حفظ البيانات للعمل الميداني';
    }
  }

  function handleGetLocation() {
    if (!navigator.geolocation) { alert('خاصية تحديد الموقع غير مدعومة في هذا المتصفح.'); return; }
    locationIconWrapper.innerHTML = ICONS.spinner; getLocationBtn.disabled = true;
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const { latitude, longitude } = position.coords;
        document.getElementById('gpsCoordinates').value = longitude.toFixed(5) + '_' + latitude.toFixed(5);
        locationIconWrapper.innerHTML = ICONS.mapPin; getLocationBtn.disabled = false;
      },
      (error) => {
        let errorMessage = 'لا يمكن الحصول على الموقع الحالي.';
        if (error.code === error.PERMISSION_DENIED) {
            errorMessage = 'تم رفض إذن الوصول إلى الموقع.';
        }
        alert(errorMessage);
        locationIconWrapper.innerHTML = ICONS.mapPin; getLocationBtn.disabled = false;
      }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  }
  
  function renderEquipment() {
    const container = document.getElementById('equipment-list');
    EQUIPMENT_LIST.forEach(function(equip) {
      container.innerHTML += `<div class="flex items-center gap-2" style="border: 1px solid var(--color-border); padding: 0.75rem; border-radius: 0.5rem;"><input type="checkbox" id="equip-${equip.id}" name="equip-${equip.id}" style="width: 1rem; height: 1rem;"><label for="equip-${equip.id}" style="font-weight: 500;">${equip.name}</label></div>`;
    });
  }

  document.addEventListener('DOMContentLoaded', async () => {
    try {
      if (typeof pako === 'undefined' || typeof Dexie === 'undefined') { showError('فشل تحميل المكتبات الأساسية. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.'); return; }
      db = new Dexie('NurseryDB');
      db.version(2).stores({ offlineCollections: '++id, synced' });
      
      form = document.getElementById('collectionForm'); formContainer = document.getElementById('form-container'); errorContainer = document.getElementById('error-container');
      errorMessage = document.getElementById('error-message'); statusMessageArea = document.getElementById('status-message-area');
      getLocationBtn = document.getElementById('getLocationBtn'); locationIconWrapper = document.getElementById('location-icon-wrapper');
      exportBtn = document.getElementById('exportBtn'); exportText = document.getElementById('export-text'); exportIcon = document.getElementById('export-icon-wrapper');
      exportOutputContainer = document.getElementById('export-output-container'); exportOutput = document.getElementById('export-output'); copyBtn = document.getElementById('copyBtn');

      locationIconWrapper.innerHTML = ICONS.mapPin; exportIcon.innerHTML = ICONS.export; renderEquipment();
      
      baseData = decodeData(encodedData);
      document.getElementById('barcodeId').value = baseData.barcodeId; document.getElementById('plantName').value = baseData.plantName;
      document.getElementById('scientificName').value = baseData.scientificName; document.getElementById('userEmail').value = baseData.userEmail || 'غير معروف';
      document.getElementById('collectionDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('collectionTime').value = new Date().toTimeString().split(' ')[0].substring(0,5);

      await updatePendingCount();
      
      form.addEventListener('submit', handleFormSubmit); getLocationBtn.addEventListener('click', handleGetLocation);
      exportBtn.addEventListener('click', handleExport); copyBtn.addEventListener('click', handleCopy);

    } catch (e) { showError('حدث خطأ غير متوقع أثناء تهيئة الصفحة: ' + e.message); console.error('Initialization error:', e); }
  });
</script>
</body>
</html>
