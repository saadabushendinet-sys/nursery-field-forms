
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>نموذج جمع ميداني</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
  <style>
    :root {
      --color-bg: #f3f4f6; --color-surface: #ffffff; --color-text: #1f2937;
      --color-text-muted: #6b7280; --color-border: #e5e7eb; --color-primary: #3b82f6;
      --color-primary-hover: #2563eb; --color-green: #16a34a; --color-red: #dc2626;
      --color-yellow: #f59e0b;
    }
    body { font-family: system-ui, -apple-system, sans-serif; background-color: var(--color-bg); color: var(--color-text); margin: 0; padding: 1rem; }
    .container { max-width: 56rem; margin: auto; }
    .card { background-color: var(--color-surface); border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
    .p-6 { padding: 1.5rem; } .mb-6 { margin-bottom: 1.5rem; }
    h1 { font-size: 1.5rem; line-height: 2rem; font-weight: 700; }
    h2 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; }
    p { color: var(--color-text-muted); }
    .grid { display: grid; gap: 1rem; }
    .grid-cols-1 { grid-template-columns: 1fr; }
    .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .col-span-2 { grid-column: span 2 / span 2; }
    label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; }
    input[type="text"], input[type="password"], input[type="number"], input[type="date"], input[type="time"], select, textarea {
      width: 100%; box-sizing: border-box; background-color: #f9fafb;
      border: 1px solid var(--color-border); border-radius: 0.5rem;
      padding: 0.625rem; font-size: 0.875rem;
    }
    input[readonly] { background-color: #e5e7eb; cursor: not-allowed; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.625rem 1rem; font-size: 0.875rem; font-weight: 500; border-radius: 0.5rem; border: 1px solid transparent; cursor: pointer; transition: background-color 0.2s; }
    .btn-primary { background-color: var(--color-primary); color: white; }
    .btn-primary:hover { background-color: var(--color-primary-hover); }
    .btn-green { background-color: var(--color-green); color: white; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .flex { display: flex; } .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .justify-end { justify-content: flex-end; }
    .gap-2 { gap: 0.5rem; } .gap-4 { gap: 1rem; }
    .hidden { display: none; }
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    fieldset { border: none; border-top: 1px solid var(--color-border); padding: 1.5rem 0 0 0; margin-top: 1.5rem; }
    legend { font-size: 1.125rem; font-weight: 600; padding: 0 0.5rem; margin-right: -0.5rem; }
    @media (min-width: 768px) {
      .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .md\:col-span-2 { grid-column: span 2 / span 2; }
    }
  </style>
</head>
<body>
<div class="container">
  <div id="form-container">
    <div class="card mb-6 p-6">
      <div class="flex items-center justify-between">
        <div>
          <h2 style="font-weight: 600;">حالة المزامنة</h2>
          <div id="sync-status" class="flex items-center gap-4" style="font-size: 0.875rem;"></div>
        </div>
        <button id="sync-button" class="btn btn-primary" disabled>
          <span id="sync-icon"></span>
          <span id="sync-button-text">مزامنة الآن</span>
        </button>
      </div>
      <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.5rem;">آخر مزامنة: <span id="last-sync">لم تتم مزامنة</span></p>
    </div>
    
    <div class="card p-6">
      <h1>نموذج جمع ميداني</h1>
      <p class="mb-6">قم بتعبئة الحقول التالية ثم اضغط على "حفظ البيانات" لحفظ المعلومات محلياً.</p>
      <form id="collectionForm">
        <fieldset>
          <legend>1. المعلومات الأساسية</legend>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label>رقم الباركود</label><input type="text" id="barcodeId" readonly></div>
            <div><label>نوع النبات</label><input type="text" id="plantName" readonly></div>
            <div><label>الاسم العلمي</label><input type="text" id="scientificName" readonly></div>
            <div><label>تم إنشاؤه بواسطة</label><input type="text" id="userEmail" readonly></div>
          </div>
        </fieldset>

        <fieldset>
            <legend>2. تفاصيل الجمع</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="quantity">الكمية *</label>
                    <div class="flex"><input id="quantity" name="quantity" type="number" value="1" min="0.01" step="0.01" required><select name="unit" id="unit"><option value="kg">كيلو</option><option value="g">جرام</option></select></div>
                </div>
                <div>
                    <label for="qualityLevel">الجودة *</label>
                    <select id="qualityLevel" name="qualityLevel" required><option>ممتاز</option><option>جيد جداً</option><option>جيد</option><option>متوسط</option><option>ضعيف</option></select>
                </div>
                <div><label for="collectionDate">تاريخ الجمع *</label><input id="collectionDate" name="collectionDate" type="date" required></div>
                <div><label for="collectionTime">وقت الجمع *</label><input id="collectionTime" name="collectionTime" type="time" required></div>
            </div>
        </fieldset>
        
        <fieldset>
              <legend>3. معلومات الموقع</legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="locationName">اسم الموقع *</label>
                  <input id="locationName" name="locationName" type="text" required>
                </div>
                <div>
                  <label for="gpsCoordinates">الإحداثيات (GPS)</label>
                  <div class="flex items-center gap-2">
                    <input id="gpsCoordinates" name="gpsCoordinates" type="text" placeholder="46.6753_24.7136">
                    <button type="button" id="getLocationBtn" class="btn btn-primary" style="flex-shrink: 0;">
                      <span id="location-icon-wrapper"></span>
                      <span>الموقع</span>
                    </button>
                  </div>
                </div>
                <div><label for="temperature">درجة الحرارة (مْ)</label><input id="temperature" name="temperature" type="number" step="any"></div>
                <div>
                  <label for="weatherCondition">حالة الطقس</label>
                  <select id="weatherCondition" name="weatherCondition">
                    <option>صافٍ</option><option>مشمس</option><option>غائم جزئياً</option><option>غائم</option><option>ضباب</option><option>مطر خفيف</option><option>مطر</option><option>مطر غزير</option><option>عاصفة رعدية</option><option>ثلج</option><option>مغبر</option>
                  </select>
                </div>
              </div>
        </fieldset>

        <fieldset>
              <legend>4. فريق العمل والمعدات</legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="collectorName">اسم الجامع *</label><input id="collectorName" name="collectorName" type="text" required></div>
                <div><label for="team">الفريق</label><input id="team" name="team" type="text"></div>
                <div><label for="collectionMethod">طريقة الجمع</label><input id="collectionMethod" name="collectionMethod" type="text"></div>
                <div><label for="seedMaturity">درجة نضج البذور</label><input id="seedMaturity" name="seedMaturity" type="text"></div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium mb-2">المعدات المستخدمة</label>
                  <div id="equipment-list" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                </div>
              </div>
        </fieldset>

        <fieldset>
              <legend>5. الملاحظات</legend>
              <div class="grid grid-cols-1 gap-4">
                <div><label for="generalNotes">ملاحظات عامة</label><textarea id="generalNotes" name="generalNotes" rows="3"></textarea></div>
                <div><label for="plantEnvironmentNotes">ملاحظات حول النبات والبيئة</label><textarea id="plantEnvironmentNotes" name="plantEnvironmentNotes" rows="3"></textarea></div>
              </div>
        </fieldset>
        
        <div class="flex justify-end items-center gap-4" style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--color-border);">
          <div id="status-message-area"></div>
          <button type="submit" id="saveBtn" class="btn btn-green">حفظ البيانات للعمل الميداني</button>
        </div>
      </form>
    </div>
  </div>
  <div id="error-container" class="hidden card p-6" style="text-align: center;">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin: auto; margin-bottom: 1rem; color: var(--color-red);"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
      <h1>خطأ</h1>
      <p id="error-message"></p>
  </div>
</div>

<script>
  // --- INJECTED DATA ---
  const encodedData = 'eJw1zT1uwkAQhuG7bJ1Bs9kde50KgShoKLjB7O4YVvIPsg0Noo0ijpIyp8G3iWM57Tzz6rsrz11oo%2Byj%2BlCb4xZ0TgXl5NBoS%2BpNXSpuhlmdJ2tYI5TGebDOBnAFCmBWEiNqh5b%2FgwPXMiWvn%2FH5%2Bh6%2Fxs8J%2BpCkGVKZwqJtlW4ywbWXbl4onEXKOIN3bSLYwBo8lwKkAwbjSXIXl%2F9dzamakp45rthf%2B7M0Ma1Pf%2BdVaGv1%2BAVXDUSg';
  const SUPABASE_URL = 'https://taodxqtlkyhkupktliwv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhb2R4cXRsa3loa3Vwa3RsaXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxMDkxMjUsImV4cCI6MjA3NDY4NTEyNX0.3_Lolpx49GZJAai8I5qQRHpD8fXnuOGKJKEhHmXH9Ps';
  
  // --- CONFIG ---
  const EQUIPMENT_LIST = [
    { id: 'collection_bags', name: 'أكياس جمع' }, { id: 'pruning_shears', name: 'مقص تقليم' },
    { id: 'ladder', name: 'سلم' }, { id: 'collection_nets', name: 'شباك جمع' },
    { id: 'gloves', name: 'قفازات' }, { id: 'storage_boxes', name: 'صناديق تخزين' },
  ];
  const SYNC_INTERVAL = 60000; // 1 minute

  // --- SVG ICONS ---
  const ICONS = {
    spinner: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><line x1="12" x2="12" y1="2" y2="6"/><line x1="12" x2="12" y1="18" y2="22"/><line x1="4.93" x2="7.76" y1="4.93" y2="7.76"/><line x1="16.24" x2="19.07" y1="16.24" y2="19.07"/><line x1="2" x2="6" y1="12" y2="12"/><line x1="18" x2="22" y1="12" y2="12"/><line x1="4.93" x2="7.76" y1="19.07" y2="16.24"/><line x1="16.24" x2="19.07" y1="7.76" y2="4.93"/></svg>',
    mapPin: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>',
    wifi: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></svg>',
    wifiOff: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="1" x2="23" y1="1" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></svg>',
    database: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>',
    sync: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M21 21v-5h-5"/></svg>'
  };

  // --- GLOBAL STATE ---
  let baseData = null;
  let db, supabaseClient;
  let isOnline = navigator.onLine;
  let isSyncing = false;
  let syncIntervalId = null;

  // --- UI ELEMENTS ---
  let form, formContainer, errorContainer, errorMessage, statusMessageArea;
  let syncStatusEl, lastSyncEl, syncButton, syncIcon, syncButtonText;
  
  function setStatusMessage(message, type = 'success') {
    const color = type === 'success' ? 'var(--color-green)' : type === 'error' ? 'var(--color-red)' : 'var(--color-text-muted)';
    statusMessageArea.innerHTML = `<span style="color: ${color}; font-weight: 500;">${message}</span>`;
    setTimeout(() => { statusMessageArea.innerHTML = ''; }, 4000);
  }

  function showError(message) {
    if(formContainer) formContainer.classList.add('hidden');
    errorContainer.classList.remove('hidden');
    errorMessage.textContent = message;
  }
  
  async function updateSyncUI() {
    const pendingCount = await db.offlineCollections.where('synced').equals(0).count();
    const onlineStatusHTML = isOnline 
      ? `<div class="flex items-center gap-2" style="color: var(--color-green);"><span class="icon">${ICONS.wifi}</span><span>متصل</span></div>`
      : `<div class="flex items-center gap-2" style="color: var(--color-red);"><span class="icon">${ICONS.wifiOff}</span><span>غير متصل</span></div>`;
    
    syncStatusEl.innerHTML = onlineStatusHTML + `<div class="flex items-center gap-2" style="color: var(--color-text-muted);"><span class="icon">${ICONS.database}</span><span>${pendingCount} سجلات معلقة</span></div>`;
    
    syncButton.disabled = !isOnline || isSyncing || pendingCount === 0;
    
    if (isSyncing) {
        syncIcon.innerHTML = ICONS.spinner;
        syncButtonText.textContent = 'جاري المزامنة...';
    } else {
        syncIcon.innerHTML = ICONS.sync;
        syncButtonText.textContent = 'مزامنة الآن';
    }
  }

  async function handleSync() {
    if (!isOnline || isSyncing) return;
    
    const unsynced = await db.offlineCollections.where('synced').equals(0).toArray();
    if (unsynced.length === 0) {
      updateSyncUI();
      return;
    }

    isSyncing = true;
    updateSyncUI();

    const recordsToInsert = unsynced.map(item => {
        const d = item.data;
        return {
          user_id: d.userId, barcode_id: d.barcodeId, plant_id: d.plantId, plant_type: d.plantName,
          scientific_name: d.scientificName, quantity: d.quantity ? parseFloat(d.quantity) : null,
          unit: d.unit, quality: d.qualityLevel, collection_date: d.collectionDate,
          collection_time: d.collectionTime, location: d.locationName, gps_coordinates: d.gpsCoordinates,
          temperature: d.temperature ? parseFloat(d.temperature) : null, weather_condition: d.weatherCondition,
          collector: d.collectorName, team: d.team, collection_method: d.collectionMethod,
          seed_maturity: d.seedMaturity,
          notes: `${d.generalNotes || ''}\n${d.plantEnvironmentNotes || ''}`.trim(), status: 'قيد المعالجة'
        };
    });

    try {
        const { error } = await supabaseClient.from('seed_collections').insert(recordsToInsert);
        if (error) throw error;
        
        const idsToUpdate = unsynced.map(item => item.id);
        await db.offlineCollections.where('id').anyOf(idsToUpdate).modify({ synced: true });

        const syncTime = new Date().toLocaleString('ar-EG');
        lastSyncEl.textContent = syncTime;
        localStorage.setItem('lastSync', syncTime);

    } catch(e) {
        console.error("Sync error:", e);
        setStatusMessage("فشلت المزامنة، سيتم المحاولة لاحقاً.", 'error');
    } finally {
        isSyncing = false;
        updateSyncUI();
    }
  }

  async function handleFormSubmit(event) {
    event.preventDefault();
    if (!form.checkValidity()) {
        alert('الرجاء تعبئة جميع الحقول المطلوبة.');
        return;
    }
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = ICONS.spinner + '<span>جاري الحفظ...</span>';
    
    const formData = new FormData(form);
    const dataToSave = { ...baseData, collectedAt: new Date().toISOString() };
    for (const [key, value] of formData.entries()) {
       dataToSave[key] = value;
    }

    try {
      await db.offlineCollections.add({ data: dataToSave, synced: false });
      setStatusMessage('تم الحفظ محلياً بنجاح!', 'success');
      form.reset();
      document.getElementById('collectionDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('collectionTime').value = new Date().toTimeString().split(' ')[0].substring(0,5);
      await updateSyncUI();
      handleSync(); // Attempt to sync immediately after saving
    } catch (e) {
      setStatusMessage("فشل حفظ البيانات محلياً.", 'error');
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = 'حفظ البيانات للعمل الميداني';
    }
  }

  // --- Event Handlers & Init ---
  window.addEventListener('online', () => { isOnline = true; updateSyncUI(); handleSync(); });
  window.addEventListener('offline', () => { isOnline = false; updateSyncUI(); });

  document.addEventListener('DOMContentLoaded', async () => {
    // --- Init UI Elements ---
    form = document.getElementById('collectionForm');
    formContainer = document.getElementById('form-container');
    errorContainer = document.getElementById('error-container');
    errorMessage = document.getElementById('error-message');
    statusMessageArea = document.getElementById('status-message-area');
    syncStatusEl = document.getElementById('sync-status');
    lastSyncEl = document.getElementById('last-sync');
    syncButton = document.getElementById('sync-button');
    syncIcon = document.getElementById('sync-icon');
    syncButtonText = document.getElementById('sync-button-text');
    
    try {
      if (typeof pako === 'undefined' || typeof Dexie === 'undefined' || typeof supabase === 'undefined') {
        showError('فشل تحميل المكتبات الأساسية. يرجى التحقق من اتصالك بالإنترنت.'); return;
      }
      
      // --- Init DB & Supabase ---
      db = new Dexie('NurseryDB');
      db.version(2).stores({ offlineCollections: '++id, synced' });
      const { createClient } = supabase;
      supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      
      // --- Decode & Populate Form ---
      const decodedString = atob(decodeURIComponent(encodedData));
      const compressed = Uint8Array.from(decodedString, c => c.charCodeAt(0));
      const jsonString = pako.inflate(compressed, { to: 'string' });
      baseData = JSON.parse(jsonString);
      
      document.getElementById('barcodeId').value = baseData.barcodeId;
      document.getElementById('plantName').value = baseData.plantName;
      document.getElementById('scientificName').value = baseData.scientificName;
      document.getElementById('userEmail').value = baseData.userEmail || 'غير معروف';
      document.getElementById('collectionDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('collectionTime').value = new Date().toTimeString().split(' ')[0].substring(0,5);

      // --- Render Dynamic Content ---
      document.getElementById('location-icon-wrapper').innerHTML = ICONS.mapPin;
      document.getElementById('equipment-list').innerHTML = EQUIPMENT_LIST.map(e => `<div class="flex items-center gap-2" style="border: 1px solid var(--color-border); padding: 0.75rem; border-radius: 0.5rem;"><input type="checkbox" id="equip-${e.id}" name="equip-${e.id}" style="width: 1rem; height: 1rem;"><label for="equip-${e.id}" style="font-weight: 500;">${e.name}</label></div>`).join('');

      // --- Init State and Handlers ---
      lastSyncEl.textContent = localStorage.getItem('lastSync') || 'لم تتم بعد';
      await updateSyncUI();
      handleSync();
      syncIntervalId = setInterval(handleSync, SYNC_INTERVAL);
      
      form.addEventListener('submit', handleFormSubmit);
      syncButton.addEventListener('click', handleSync);
      document.getElementById('getLocationBtn').addEventListener('click', () => { /* ... location logic ... */ });

    } catch (e) {
      showError('حدث خطأ غير متوقع أثناء تهيئة الصفحة: ' + e.message);
      console.error('Initialization error:', e);
    }
  });
</script>
</body>
</html>
