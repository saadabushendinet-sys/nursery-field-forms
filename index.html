
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>نموذج جمع ميداني</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
  <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
  <style>
    :root {
      --color-bg: #f3f4f6; --color-surface: #ffffff; --color-text: #1f2937;
      --color-text-muted: #6b7280; --color-border: #e5e7eb; --color-primary: #3b82f6;
      --color-primary-hover: #2563eb; --color-green: #16a34a; --color-red: #dc2626;
      --color-yellow: #f59e0b;
    }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background-color: var(--color-bg); color: var(--color-text);
      margin: 0; padding: 1rem;
    }
    .container { max-width: 56rem; margin: auto; }
    .card { background-color: var(--color-surface); border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
    .p-6 { padding: 1.5rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    h1 { font-size: 1.5rem; line-height: 2rem; font-weight: 700; }
    h2 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; }
    p { color: var(--color-text-muted); }
    .grid { display: grid; gap: 1rem; }
    .grid-cols-1 { grid-template-columns: 1fr; }
    .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .col-span-2 { grid-column: span 2 / span 2; }
    label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; }
    input[type="text"], input[type="password"], input[type="number"], input[type="date"], input[type="time"], select, textarea {
      width: 100%; box-sizing: border-box; background-color: #f9fafb;
      border: 1px solid var(--color-border); border-radius: 0.5rem;
      padding: 0.625rem; font-size: 0.875rem;
    }
    input[readonly] { background-color: #e5e7eb; cursor: not-allowed; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
      padding: 0.625rem 1rem; font-size: 0.875rem; font-weight: 500;
      border-radius: 0.5rem; border: 1px solid transparent; cursor: pointer; transition: background-color 0.2s;
    }
    .btn-primary { background-color: var(--color-primary); color: white; }
    .btn-primary:hover { background-color: var(--color-primary-hover); }
    .btn-green { background-color: var(--color-green); color: white; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .flex { display: flex; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .justify-end { justify-content: flex-end; }
    .gap-2 { gap: 0.5rem; } .gap-4 { gap: 1rem; }
    .hidden { display: none; }
    .w-4 { width: 1rem; } .h-4 { height: 1rem; }
    .w-6 { width: 1.5rem; } .h-6 { height: 1.5rem; }
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .text-green { color: var(--color-green); } .text-red { color: var(--color-red); } .text-yellow { color: var(--color-yellow); }
    .bg-green-light { background-color: #dcfce7; } .text-green-dark { color: #166534; }
    .bg-yellow-light { background-color: #fef9c3; } .text-yellow-dark { color: #854d0e; }
    .font-semibold { font-weight: 600; }
    fieldset { border: none; border-top: 1px solid var(--color-border); padding: 1.5rem 0 0 0; margin-top: 1.5rem; }
    legend { font-size: 1.125rem; font-weight: 600; padding: 0 0.5rem; margin-right: -0.5rem; }
    .local-record-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border: 1px solid var(--color-border); border-radius: 0.5rem; }
    .local-record-item + .local-record-item { margin-top: 0.75rem; }
    .status-badge { display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
    .status-badge svg { width: 0.875rem; height: 0.875rem; }
    @media (min-width: 768px) {
      .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .md\:col-span-2 { grid-column: span 2 / span 2; }
    }
  </style>
</head>
<body>
<div class="container">
  <div id="form-container">
    <div id="sync-status-header" class="card mb-6"></div>

    <div class="card mb-6">
      <div id="local-records-toggle" style="padding: 1.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600;">السجلات المحفوظة محلياً</h2>
        <svg id="records-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transition: transform 0.2s;"><path d="m6 9 6 6 6-6"/></svg>
      </div>
      <div id="local-records-container" style="padding: 0 1.5rem 1.5rem; display: none; border-top: 1px solid var(--color-border);">
          <div style="display: flex; justify-content: flex-end; padding-top: 1.5rem; border-bottom: 1px solid var(--color-border); padding-bottom: 1rem; margin-bottom: 1rem;">
            <button id="clearSyncedBtn" class="btn" style="background-color: var(--color-red); color: white;">حذف السجلات المتزامنة</button>
          </div>
          <div id="local-records-list">
              <p style="text-align: center; color: var(--color-text-muted); padding: 1rem 0;">جاري تحميل السجلات...</p>
          </div>
      </div>
    </div>
    
    <div class="card p-6">
      <h1>نموذج جمع ميداني</h1>
      <p class="mb-6">قم بتعبئة الحقول التالية ثم اضغط على "حفظ البيانات" لحفظ المعلومات محلياً.</p>
      <form id="collectionForm">
        <fieldset>
          <legend>1. المعلومات الأساسية</legend>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label>رقم الباركود</label><input type="text" id="barcodeId" readonly></div>
            <div><label>نوع النبات</label><input type="text" id="plantName" readonly></div>
            <div><label>الاسم العلمي</label><input type="text" id="scientificName" readonly></div>
            <div><label>تم إنشاؤه بواسطة</label><input type="text" id="userEmail" readonly></div>
          </div>
        </fieldset>

        <fieldset>
            <legend>2. تفاصيل الجمع</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="quantity">الكمية *</label>
                    <div class="flex"><input id="quantity" name="quantity" type="number" value="1" min="0.01" step="0.01" required><select name="unit" id="unit"><option value="kg">كيلو</option><option value="g">جرام</option></select></div>
                </div>
                <div>
                    <label for="qualityLevel">الجودة *</label>
                    <select id="qualityLevel" name="qualityLevel" required><option>ممتاز</option><option>جيد جداً</option><option>جيد</option><option>متوسط</option><option>ضعيف</option></select>
                </div>
                <div><label for="collectionDate">تاريخ الجمع *</label><input id="collectionDate" name="collectionDate" type="date" required></div>
                <div><label for="collectionTime">وقت الجمع *</label><input id="collectionTime" name="collectionTime" type="time" required></div>
            </div>
          </fieldset>
        
          <fieldset>
              <legend>3. معلومات الموقع</legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="locationName">اسم الموقع *</label>
                  <input id="locationName" name="locationName" type="text" required>
                </div>
                <div>
                  <label for="gpsCoordinates">الإحداثيات (GPS)</label>
                  <div class="flex items-center gap-2">
                    <input id="gpsCoordinates" name="gpsCoordinates" type="text" placeholder="46.6753_24.7136">
                    <button type="button" id="getLocationBtn" class="btn btn-primary" style="flex-shrink: 0;">
                      <span id="location-icon-wrapper"></span>
                      <span>الموقع</span>
                    </button>
                  </div>
                </div>
                <div><label for="temperature">درجة الحرارة (مْ)</label><input id="temperature" name="temperature" type="number" step="any"></div>
                <div>
                  <label for="weatherCondition">حالة الطقس</label>
                  <select id="weatherCondition" name="weatherCondition">
                    <option>صافٍ</option><option>مشمس</option><option>غائم جزئياً</option><option>غائم</option><option>ضباب</option><option>مطر خفيف</option><option>مطر</option><option>مطر غزير</option><option>عاصفة رعدية</option><option>ثلج</option><option>مغبر</option>
                  </select>
                </div>
              </div>
          </fieldset>

          <fieldset>
              <legend>4. فريق العمل والمعدات</legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="collectorName">اسم الجامع *</label><input id="collectorName" name="collectorName" type="text" required></div>
                <div><label for="team">الفريق</label><input id="team" name="team" type="text"></div>
                <div><label for="collectionMethod">طريقة الجمع</label><input id="collectionMethod" name="collectionMethod" type="text"></div>
                <div><label for="seedMaturity">درجة نضج البذور</label><input id="seedMaturity" name="seedMaturity" type="text"></div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium mb-2">المعدات المستخدمة</label>
                  <div id="equipment-list" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                </div>
              </div>
          </fieldset>

          <fieldset>
              <legend>5. الملاحظات</legend>
              <div class="grid grid-cols-1 gap-4">
                <div><label for="generalNotes">ملاحظات عامة</label><textarea id="generalNotes" name="generalNotes" rows="3"></textarea></div>
                <div><label for="plantEnvironmentNotes">ملاحظات حول النبات والبيئة</label><textarea id="plantEnvironmentNotes" name="plantEnvironmentNotes" rows="3"></textarea></div>
              </div>
          </fieldset>

        <div class="flex justify-end items-center gap-4" style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--color-border);">
          <div id="status-message-area"></div>
          <button type="submit" id="saveBtn" class="btn btn-green">حفظ البيانات للعمل الميداني</button>
        </div>
      </form>
    </div>
  </div>
  <div id="error-container" class="hidden card p-6 text-center" style="text-align: center;">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin: auto; margin-bottom: 1rem;" class="text-red"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
      <h1 style="margin-bottom: 0.5rem;">خطأ</h1>
      <p id="error-message"></p>
  </div>
</div>

<script>
  // --- INJECTED DATA ---
  const encodedData = 'eJw1zT1uwkAQhuG7bJ1Bs9kde50KgShoKLjB7O4YVvIPsg0Noo0ijpIyp8G3iWM57Tzz6rsrz11oo%2Byj%2BlCb4xZ0TgXl5NBoS%2BpNXSpuhlmdJ2tYI5TGebDOBnAFCmBWEiNqh5b%2FgwPXMiWvn%2FH5%2Bh6%2Fxs8J%2BpCkGVKZwqJtlW4ywbWXbl4onEXKOIN3bSLYwBo8lwKkAwbjSXIXl%2F9dzamakp45rthf%2B7M0Ma1Pf%2BdVaGv1%2BAVXDUSg';
  const SUPABASE_URL = 'https://taodxqtlkyhkupktliwv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhb2R4cXRsa3loa3Vwa3RsaXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxMDkxMjUsImV4cCI6MjA3NDY4NTEyNX0.3_Lolpx49GZJAai8I5qQRHpD8fXnuOGKJKEhHmXH9Ps';

  // --- CONFIG ---
  const EQUIPMENT_LIST = [
    { id: 'collection_bags', name: 'أكياس جمع' }, { id: 'pruning_shears', name: 'مقص تقليم' },
    { id: 'ladder', name: 'سلم' }, { id: 'collection_nets', name: 'شباك جمع' },
    { id: 'gloves', name: 'قفازات' }, { id: 'storage_boxes', name: 'صناديق تخزين' },
  ];

  // --- FIX: Add missing ICONS constant definition ---
  // --- SVG ICONS ---
  const ICONS = {
    wifi: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-green"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></svg>',
    wifiOff: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-red"><line x1="1" x2="23" y1="1" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a11 11 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a16 16 0 0 1 4.71-2.64"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></svg>',
    spinner: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 animate-spin"><line x1="12" x2="12" y1="2" y2="6"/><line x1="12" x2="12" y1="18" y2="22"/><line x1="4.93" x2="7.76" y1="4.93" y2="7.76"/><line x1="16.24" x2="19.07" y1="16.24" y2="19.07"/><line x1="2" x2="6" y1="12" y2="12"/><line x1="18" x2="22" y1="12" y2="12"/><line x1="4.93" x2="7.76" y1="19.07" y2="16.24"/><line x1="16.24" x2="19.07" y1="7.76" y2="4.93"/></svg>',
    refresh: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg>',
    mapPin: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>',
    synced: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="24" height="24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
    pending: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="24" height="24"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg>',
  };

  // --- GLOBAL STATE ---
  let isOnline = navigator.onLine;
  let isSyncing = false;
  let pendingCount = 0;
  let lastSync = null;
  let baseData = null;
  let db;

  // --- UI ELEMENTS ---
  let form, formContainer, errorContainer, errorMessage, syncHeader, statusMessageArea, getLocationBtn, locationIconWrapper, recordsToggle, recordsContainer, recordsChevron, clearSyncedBtn;
  
  function setStatusMessage(message, type = 'success') {
    const color = type === 'success' ? 'var(--color-green)' : type === 'error' ? 'var(--color-red)' : 'var(--color-text-muted)';
    statusMessageArea.innerHTML = `<span style="color: ${color}; font-weight: 500;">${message}</span>`;
    if (type !== 'info') {
      setTimeout(() => { statusMessageArea.innerHTML = ''; }, 4000);
    }
  }

  function showError(message) {
      formContainer.classList.add('hidden');
      errorContainer.classList.remove('hidden');
      errorMessage.textContent = message;
  }

  function decodeData(encodedString) {
    const base64String = decodeURIComponent(encodedString);
    const binaryString = atob(base64String);
    const compressed = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
        compressed[i] = binaryString.charCodeAt(i);
    }
    const jsonString = pako.inflate(compressed, { to: 'string' });
    return JSON.parse(jsonString);
  }

  async function updatePendingCount() {
    pendingCount = await db.offlineCollections.where('synced').equals(0).count();
    updateSyncUI();
  }
  
  function populateFormFromRecord(data) {
    if (!data) return;
    form.reset();
    for (const key in data) {
        if (form.elements[key]) {
             if (typeof data[key] === 'object' && form.elements[key].type !== 'select-one') {
                // Skip objects like equipmentUsed
            } else if (form.elements[key].type === 'checkbox') {
                // skip for now
            }
            else {
                form.elements[key].value = data[key];
            }
        }
    }
    const equipmentUsed = data.equipmentUsed || {};
    document.querySelectorAll('#equipment-list input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = equipmentUsed[checkbox.name]?.used || false;
    });
    const tempMsg = document.createElement('div');
    tempMsg.textContent = 'تم ملء النموذج ببيانات السجل المحفوظ.';
    tempMsg.style.cssText = 'background-color: #e0f2fe; color: #075985; padding: 0.75rem 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; text-align: center;';
    form.insertBefore(tempMsg, form.firstChild);
    setTimeout(() => tempMsg.remove(), 3000);
    form.scrollIntoView({ behavior: 'smooth' });
  }

  async function renderLocalRecords() {
    const listContainer = document.getElementById('local-records-list');
    if (!listContainer) return;
    listContainer.innerHTML = '<p style="text-align: center; color: var(--color-text-muted); padding: 1rem 0;">جاري تحميل السجلات...</p>';
    try {
      const records = await db.offlineCollections.orderBy('id').reverse().toArray();
      if (records.length === 0) {
        listContainer.innerHTML = '<p style="text-align: center; color: var(--color-text-muted); padding: 1rem 0;">لا توجد سجلات محفوظة محلياً.</p>';
        return;
      }
      listContainer.innerHTML = '';
      records.forEach(function(record) {
        const d = record.data;
        const statusIcon = record.synced ? ICONS.synced : ICONS.pending;
        const statusText = record.synced ? 'تمت المزامنة' : 'بانتظار المزامنة';
        const statusBadgeClass = record.synced ? 'bg-green-light text-green-dark' : 'bg-yellow-light text-yellow-dark';
        const collectedDate = new Date(d.collectedAt || Date.now());
        const displayDate = collectedDate.toLocaleDateString('ar-EG', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const displayTime = collectedDate.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true });

        const itemEl = document.createElement('div');
        itemEl.className = 'local-record-item';
        
        const syncedCheckmark = record.synced 
            ? `<div style="color: var(--color-green);">${ICONS.synced}</div>`
            : `<div style="width: 24px;"></div>`; // Placeholder for alignment

        itemEl.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.75rem; flex-grow: 1;">
                ${syncedCheckmark}
                <div>
                     <p class="font-semibold">${d.plantName || 'N/A'} - ${d.quantity || 'N/A'} ${d.unit || ''}</p>
                     <p style="font-size: 0.75rem; color: var(--color-text-muted);">وقت الحفظ: ${displayDate} ${displayTime}</p>
                </div>
            </div>
            <div class="status-badge ${statusBadgeClass}" style="flex-shrink: 0;">
                <span>${statusText}</span>
            </div>`;
        
        itemEl.style.cursor = 'pointer';
        itemEl.addEventListener('click', () => populateFormFromRecord(d));
        
        listContainer.appendChild(itemEl);
      });
    } catch (e) {
      console.error('Failed to render local records:', e);
      listContainer.innerHTML = '<p class="text-red">فشل تحميل السجلات المحفوظة.</p>';
    }
  }

  async function handleClearSynced() {
    if (confirm('هل أنت متأكد من حذف جميع السجلات التي تمت مزامنتها؟ لا يمكن التراجع عن هذا الإجراء.')) {
        try {
            await db.offlineCollections.where('synced').equals(1).delete();
            await updatePendingCount();
            await renderLocalRecords();
        } catch(e) { console.error('Failed to clear synced records:', e); alert('حدث خطأ أثناء حذف السجلات.'); }
    }
  }

  async function syncPendingCollections() {
    if (!isOnline || isSyncing) return;
    
    if (SUPABASE_URL === '__SUPABASE_URL__' || SUPABASE_ANON_KEY === '__SUPABASE_ANON_KEY__') {
      console.log("Supabase sync is not configured. Skipping sync.");
      setStatusMessage('مزامنة Supabase غير مهيأة.', 'info');
      return;
    }

    isSyncing = true;
    updateSyncUI();
    
    const unsynced = await db.offlineCollections.where('synced').equals(0).toArray();
    if (unsynced.length === 0) {
      isSyncing = false;
      lastSync = new Date();
      updateSyncUI();
      await renderLocalRecords();
      return;
    }

    const url = `${SUPABASE_URL}/rest/v1/seed_collections`;
    const headers = {
      'apikey': SUPABASE_ANON_KEY,
      'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': 'return=minimal',
    };
    
    const recordsToSync = [];
    const itemIdsToUpdate = [];
    
    for (const item of unsynced) {
      const d = item.data;
      const equipmentUsed = Object.keys(d.equipmentUsed || {})
          .filter(key => d.equipmentUsed[key].used)
          .map(key => EQUIPMENT_LIST.find(e => e.id === key)?.name)
          .filter(Boolean);

      const notes = `${d.generalNotes || ''}
${d.plantEnvironmentNotes || ''}
${equipmentUsed.length > 0 ? 'المعدات المستخدمة: ' + equipmentUsed.join(', ') : ''}`.trim();

      const record = {
          user_id: d.userId,
          barcode_id: d.barcodeId,
          plant_id: d.plantId,
          plant_type: d.plantName,
          scientific_name: d.scientificName,
          quantity: d.quantity ? parseFloat(d.quantity) : null,
          unit: d.unit,
          quality: d.qualityLevel,
          collection_date: d.collectionDate,
          collection_time: d.collectionTime,
          location: d.locationName,
          gps_coordinates: d.gpsCoordinates,
          temperature: d.temperature ? parseFloat(d.temperature) : null,
          weather_condition: d.weatherCondition,
          collector: d.collectorName,
          team: d.team,
          collection_method: d.collectionMethod,
          seed_maturity: d.seedMaturity,
          notes: notes,
          status: 'قيد المعالجة',
      };
      recordsToSync.push(record);
      if(item.id) itemIdsToUpdate.push(item.id);
    }

    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(recordsToSync),
      });

      if (!response.ok) {
         const errorText = await response.text();
         console.error('Supabase batch sync error:', errorText);
         throw new Error(`Failed to sync with status: ${response.status}`);
      }
      
      for (const id of itemIdsToUpdate) {
        await db.offlineCollections.update(id, { synced: true });
      }

      lastSync = new Date();
      if (unsynced.length > 0) {
        setStatusMessage(`تمت مزامنة ${itemIdsToUpdate.length} من ${unsynced.length} سجل بنجاح!`, 'success');
      }
    } catch (e) {
      console.error("Error during Supabase sync:", e);
      setStatusMessage('فشل المزامنة مع Supabase. سيتم المحاولة لاحقاً.', 'error');
    } finally {
      isSyncing = false;
      await updatePendingCount();
      await renderLocalRecords();
      updateSyncUI();
    }
  }
  
  function updateSyncUI() {
    const onlineIcon = isOnline ? ICONS.wifi : ICONS.wifiOff;
    const onlineText = isOnline ? 'متصل بالإنترنت' : 'غير متصل بالإنترنت';
    const onlineSubtext = isOnline ? 'المزامنة التلقائية مفعلة.' : 'سيتم حفظ البيانات محلياً.';
    const onlineColor = isOnline ? 'text-green' : 'text-red';
    const syncButtonContent = isSyncing ? ICONS.spinner + '<span>جاري المزامنة...</span>' : ICONS.refresh + '<span>مزامنة الآن</span>';
    syncHeader.innerHTML = `<div class="flex justify-between items-center gap-4" style="flex-wrap: wrap;"><div class="flex items-center gap-2">${onlineIcon}<div><p class="font-semibold ${onlineColor}">${onlineText}</p><p style="font-size: 0.75rem; color: var(--color-text-muted);">${onlineSubtext}</p></div></div><div style="text-align: center;"><p class="font-semibold">${pendingCount}</p><p style="font-size: 0.75rem; color: var(--color-text-muted);">بانتظار المزامنة</p></div><div style="text-align: center;"><p class="font-semibold">${lastSync ? lastSync.toLocaleTimeString('ar-EG') : 'لم تتم'}</p><p style="font-size: 0.75rem; color: var(--color-text-muted);">آخر مزامنة</p></div><button id="syncNowBtn" ${!isOnline || isSyncing ? 'disabled' : ''} class="btn btn-primary">${syncButtonContent}</button></div>`;
    syncHeader.style.borderLeft = '4px solid ' + (isOnline ? 'var(--color-green)' : 'var(--color-red)');
    document.getElementById('syncNowBtn').addEventListener('click', syncPendingCollections);
  }

  async function handleFormSubmit(event) {
    event.preventDefault();
    if (!form.checkValidity()) {
        alert('الرجاء تعبئة جميع الحقول المطلوبة.');
        return;
    }
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = ICONS.spinner + '<span>جاري الحفظ...</span>';
    
    const formData = new FormData(form);
    const dataToSave = { ...baseData, collectedAt: new Date().toISOString() };
    const equipmentUsed = {};
    for (const [key, value] of formData.entries()) {
       if (key.startsWith('equip-')) {
            const equipId = key.replace('equip-', '');
            equipmentUsed[equipId] = { used: value === 'on' };
       } else {
            dataToSave[key] = value;
       }
    }
    dataToSave['equipmentUsed'] = equipmentUsed;

    try {
      await db.offlineCollections.add({ data: dataToSave, synced: false });
      setStatusMessage('تم الحفظ محلياً بنجاح!', 'success');
      form.reset();
      document.getElementById('collectionDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('collectionTime').value = new Date().toTimeString().split(' ')[0].substring(0,5);
      document.getElementById('quantity').value = '1';
      document.getElementById('unit').value = 'kg';

      await updatePendingCount();
      await renderLocalRecords();
      
      if (isOnline) {
        syncPendingCollections();
      }
    } catch (e) {
      console.error("Failed to save to IndexedDB", e);
      setStatusMessage("فشل حفظ البيانات محلياً.", 'error');
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = 'حفظ البيانات للعمل الميداني';
    }
  }
  
  function mapWeatherCode(code) {
      if (code === 0) return 'صافٍ';
      if (code >= 1 && code <= 3) return 'غائم جزئياً';
      if (code === 45 || code === 48) return 'ضباب';
      if (code >= 51 && code <= 57) return 'مطر خفيف';
      if (code >= 61 && code <= 67) return 'مطر';
      if (code >= 80 && code <= 82) return 'مطر غزير';
      if (code >= 71 && code <= 77) return 'ثلج';
      if (code >= 95 && code <= 99) return 'عاصفة رعدية';
      return 'مشمس';
  }

  function handleGetLocation() {
    if (!navigator.geolocation) { alert('خاصية تحديد الموقع غير مدعومة في هذا المتصفح.'); return; }
    locationIconWrapper.innerHTML = ICONS.spinner; getLocationBtn.disabled = true;
    navigator.geolocation.getCurrentPosition(
      async (position) => {
        try {
            const { latitude, longitude } = position.coords;
            document.getElementById('gpsCoordinates').value = longitude.toFixed(5) + '_' + latitude.toFixed(5);
            if (!navigator.onLine) { alert('أنت غير متصل بالإنترنت. تم تحديد الإحداثيات فقط.'); return; }
            const [geoRes, weatherRes] = await Promise.all([
                fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + latitude + '&lon=' + longitude + '&accept-language=ar'),
                fetch('https://api.open-meteo.com/v1/forecast?latitude=' + latitude + '&longitude=' + longitude + '&current=temperature_2m,weather_code')
            ]);
            if (!geoRes.ok || !weatherRes.ok) throw new Error('فشل جلب بيانات الموقع أو الطقس.');
            const geoData = await geoRes.json(); const weatherData = await weatherRes.json();
            document.getElementById('locationName').value = geoData.display_name || '';
            document.getElementById('temperature').value = weatherData.current.temperature_2m;
            document.getElementById('weatherCondition').value = mapWeatherCode(weatherData.current.weather_code);
        } catch (error) {
            console.error('Error fetching location/weather details:', error);
            alert('لم نتمكن من جلب اسم الموقع والطقس تلقائياً. تم تحديد الإحداثيات فقط.');
        } finally { locationIconWrapper.innerHTML = ICONS.mapPin; getLocationBtn.disabled = false; }
      },
      (error) => {
        let errorMessage = 'لا يمكن الحصول على الموقع الحالي. يرجى إدخاله يدوياً.';
        switch(error.code) {
            case error.PERMISSION_DENIED: errorMessage = 'تم رفض إذن الوصول إلى الموقع.'; break;
            case error.POSITION_UNAVAILABLE: errorMessage = 'معلومات الموقع غير متاحة.'; break;
            case error.TIMEOUT: errorMessage = 'انتهت مهلة طلب الموقع.'; break;
        }
        alert(errorMessage); console.error('Geolocation Error:', error.message);
        locationIconWrapper.innerHTML = ICONS.mapPin; getLocationBtn.disabled = false;
      }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
  }
  
  function renderEquipment() {
    const container = document.getElementById('equipment-list');
    EQUIPMENT_LIST.forEach(function(equip) {
      container.innerHTML += `<div class="flex items-center gap-2" style="border: 1px solid var(--color-border); padding: 0.75rem; border-radius: 0.5rem;"><input type="checkbox" id="equip-${equip.id}" name="equip-${equip.id}" style="width: 1rem; height: 1rem;"><label for="equip-${equip.id}" style="font-weight: 500;">${equip.name}</label></div>`;
    });
  }

  document.addEventListener('DOMContentLoaded', async () => {
    try {
      if (typeof pako === 'undefined' || typeof Dexie === 'undefined') { showError('فشل تحميل المكتبات الأساسية. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.'); return; }
      db = new Dexie('NurseryDB');
      db.version(2).stores({ offlineCollections: '++id, synced' });
      
      form = document.getElementById('collectionForm'); formContainer = document.getElementById('form-container'); errorContainer = document.getElementById('error-container');
      errorMessage = document.getElementById('error-message'); syncHeader = document.getElementById('sync-status-header'); statusMessageArea = document.getElementById('status-message-area');
      getLocationBtn = document.getElementById('getLocationBtn'); locationIconWrapper = document.getElementById('location-icon-wrapper'); recordsToggle = document.getElementById('local-records-toggle');
      recordsContainer = document.getElementById('local-records-container'); recordsChevron = document.getElementById('records-chevron'); clearSyncedBtn = document.getElementById('clearSyncedBtn');

      locationIconWrapper.innerHTML = ICONS.mapPin; renderEquipment();
      
      baseData = decodeData(encodedData);
      document.getElementById('barcodeId').value = baseData.barcodeId; document.getElementById('plantName').value = baseData.plantName;
      document.getElementById('scientificName').value = baseData.scientificName; document.getElementById('userEmail').value = baseData.userEmail || 'غير معروف';
      document.getElementById('collectionDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('collectionTime').value = new Date().toTimeString().split(' ')[0].substring(0,5);

      await updatePendingCount(); await renderLocalRecords(); if (isOnline) syncPendingCollections();
      
      form.addEventListener('submit', handleFormSubmit); getLocationBtn.addEventListener('click', handleGetLocation);
      recordsToggle.addEventListener('click', () => {
        const isHidden = recordsContainer.style.display === 'none';
        recordsContainer.style.display = isHidden ? 'block' : 'none';
        recordsChevron.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
      });

      clearSyncedBtn.addEventListener('click', handleClearSynced);
      window.addEventListener('online', () => { isOnline = true; updateSyncUI(); syncPendingCollections(); });
      window.addEventListener('offline', () => { isOnline = false; updateSyncUI(); });
    } catch (e) { showError('حدث خطأ غير متوقع أثناء تهيئة الصفحة: ' + e.message); console.error('Initialization error:', e); }
  });
</script>
</body>
</html>
