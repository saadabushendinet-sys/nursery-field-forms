
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>نموذج جمع ميداني</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
  <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
</head>
<body class="bg-gray-100">
  <div class="max-w-4xl mx-auto p-4 sm:p-8">
    <!-- SYNC STATUS -->
    <div id="sync-status-container" class="bg-white p-4 rounded-xl shadow-md mb-6 border-l-4"></div>

    <!-- MAIN FORM -->
    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
      <h1 class="text-2xl font-bold mb-2">نموذج جمع ميداني</h1>
      <p id="error-message" class="text-red-500 mb-6 hidden"></p>

      <div id="form-content">
        <!-- Basic Info -->
        <fieldset class="border-t pt-4 mb-6">
          <legend class="text-lg font-semibold px-2 mb-4">المعلومات الأساسية</legend>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div><label class="block text-sm">رقم الباركود</label><input type="text" id="barcodeId" readonly class="mt-1 w-full bg-gray-200 p-2 rounded border"></div>
            <div><label class="block text-sm">نوع النبات</label><input type="text" id="plantName" readonly class="mt-1 w-full bg-gray-200 p-2 rounded border"></div>
            <div><label class="block text-sm">الاسم العلمي</label><input type="text" id="scientificName" readonly class="mt-1 w-full bg-gray-200 p-2 rounded border"></div>
          </div>
        </fieldset>
        
        <!-- Form Fields -->
        <form id="collectionForm" class="space-y-6">
          <!-- Collection Data -->
          <fieldset class="border-t pt-4">
            <legend class="text-lg font-semibold px-2 mb-4">بيانات الجمع</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="md:col-span-2">
                <label for="quantity" class="block text-sm font-medium mb-1">الكمية المجمعة *</label>
                <div class="flex"><input id="quantity" name="quantity" type="number" placeholder="0" required class="w-full text-sm bg-gray-50 border-gray-300 rounded-r-lg p-2.5 border-l-0"><select id="unit" name="unit" class="text-sm bg-gray-50 border-gray-300 rounded-l-lg p-2.5"><option>كيلو</option><option>جرام</option><option>قطعة</option></select></div>
              </div>
              <div>
                <label for="locationName" class="block text-sm font-medium mb-1">موقع الجمع *</label>
                <input id="locationName" name="locationName" type="text" required placeholder="مثال: وادي حنيفة" class="w-full text-sm bg-gray-50 border-gray-300 rounded-lg p-2.5">
              </div>
              <div>
                <label for="gpsCoordinates" class="block text-sm font-medium mb-1">الإحداثيات (GPS) *</label>
                <div class="flex items-center gap-2 mt-1">
                  <input id="gpsCoordinates" name="gpsCoordinates" required type="text" placeholder="24.7136, 46.6753" class="w-full text-sm bg-gray-50 border-gray-300 rounded-lg p-2.5">
                  <button type="button" id="getLocationBtn" class="flex items-center justify-center gap-2 px-4 py-2.5 bg-blue-600 text-white rounded-lg text-sm shrink-0 hover:bg-blue-700"><i data-lucide="map-pin" class="h-4 w-4"></i><span id="locationBtnText">الموقع</span></button>
                </div>
              </div>
              <div>
                <label for="collectorName" class="block text-sm font-medium mb-1">اسم الجامع *</label>
                <input id="collectorName" name="collectorName" required type="text" placeholder="أدخل اسم الجامع" class="w-full text-sm bg-gray-50 border-gray-300 rounded-lg p-2.5">
              </div>
            </div>
          </fieldset>
          <div class="mt-8 pt-6 border-t flex justify-end">
            <button type="submit" id="saveBtn" class="px-6 py-3 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">حفظ البيانات</button>
          </div>
          <div id="saveSuccess" class="hidden mt-4 flex items-center gap-2 text-green-600 font-semibold">
            <i data-lucide="check-circle" class="w-5 h-5"></i>
            <span>تم الحفظ محلياً بنجاح!</span>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // --- INJECTED DATA ---
    const encodedData = 'eJyrVkpKLErOT0n1TFGyUnIKctY1NDe1NDU3tTAwNjQxVdJRKshJzCsBy1okmZoYJxoa6KYZWyTpmliYJOtaWBqk6hqYpZkmGhgYWhiYJMI0+CXmpgK13Nh0s+vGqpsdN9uAEsXJmal5JZlpmclQ2fyczLJUpVoA5Kwp5g==';
    const supabaseFunctionUrl = 'https://taodxqtlkyhkupktliwv.supabase.co/functions/v1/sync-to-github';

    // --- DB SETUP ---
    const db = new Dexie('NurseryFieldDB');
    db.version(1).stores({
      collections: '++id, synced'
    });

    // --- APP STATE ---
    let isOnline = navigator.onLine;
    let isSyncing = false;
    let baseData = null;

    // --- UI ELEMENTS ---
    const form = document.getElementById('collectionForm');
    const saveBtn = document.getElementById('saveBtn');
    const saveSuccess = document.getElementById('saveSuccess');
    const syncStatusContainer = document.getElementById('sync-status-container');
    const getLocationBtn = document.getElementById('getLocationBtn');
    const locationBtnText = document.getElementById('locationBtnText');

    // --- MAIN LOGIC ---
    function initialize() {
      lucide.createIcons();
      decodeAndRenderData();
      updateSyncStatus();
      updatePendingCount();

      window.addEventListener('online', () => { isOnline = true; updateSyncStatus(); syncPending(); });
      window.addEventListener('offline', () => { isOnline = false; updateSyncStatus(); });

      form.addEventListener('submit', saveOffline);
      getLocationBtn.addEventListener('click', getOfflineLocation);
    }
    
    function decodeAndRenderData() {
      try {
        if (!encodedData || encodedData.startsWith('__')) throw new Error('No data provided');
        const binaryString = atob(encodedData);
        const compressed = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          compressed[i] = binaryString.charCodeAt(i);
        }
        const jsonString = pako.inflate(compressed, { to: 'string' });
        baseData = JSON.parse(jsonString);

        document.getElementById('barcodeId').value = baseData.barcodeId;
        document.getElementById('plantName').value = baseData.plantName;
        document.getElementById('scientificName').value = baseData.scientificName;

      } catch (e) {
        document.getElementById('error-message').textContent = 'فشل في فك تشفير بيانات النموذج. قد يكون الرابط تالفاً.';
        document.getElementById('error-message').classList.remove('hidden');
        document.getElementById('form-content').classList.add('hidden');
        console.error(e);
      }
    }
    
    async function saveOffline(event) {
        event.preventDefault();
        if (!baseData) return;

        const formData = new FormData(form);
        const formProps = Object.fromEntries(formData);
        
        if (!formProps.quantity || !formProps.locationName || !formProps.gpsCoordinates || !formProps.collectorName) {
            alert('الرجاء تعبئة جميع الحقول المطلوبة (*).');
            return;
        }

        const dataToSave = { ...baseData, ...formProps, collectedAt: new Date().toISOString() };
        
        try {
            await db.collections.add({ data: dataToSave, synced: false });
            saveSuccess.classList.remove('hidden');
            form.reset();
            updatePendingCount();
            setTimeout(() => saveSuccess.classList.add('hidden'), 3000);
            if (isOnline) syncPending();
        } catch(e) {
            console.error("Failed to save to IndexedDB", e);
            alert("فشل حفظ البيانات محلياً.");
        }
    }

    async function syncPending() {
      if (!isOnline || isSyncing) return;
      isSyncing = true;
      updateSyncStatus();

      const unsynced = await db.collections.where('synced').equals(0).toArray();
      if (unsynced.length === 0) {
        isSyncing = false;
        updateSyncStatus();
        return;
      }
      
      const recordsToSync = unsynced.map(item => item.data);

      try {
        const response = await fetch(supabaseFunctionUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ records: recordsToSync }),
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Sync failed');
        }

        // Mark as synced
        for (const item of unsynced) {
          await db.collections.update(item.id, { synced: true });
        }
        console.log(`Successfully synced ${unsynced.length} records.`);

      } catch (error) {
        console.error('Sync error:', error);
      } finally {
        isSyncing = false;
        updateSyncStatus();
        updatePendingCount();
      }
    }

    // --- UI & HELPERS ---
    function updateSyncStatus() {
        let content = '';
        if (isOnline) {
            content = `
                <div class="flex items-center gap-3">
                  <i data-lucide="wifi" class="w-6 h-6 text-green-500"></i>
                  <div><p class="font-semibold text-green-600">متصل بالإنترنت</p></div>
                </div>
                ${isSyncing ? '<p class="text-sm">جاري المزامنة...</p>' : '<p class="text-sm">المزامنة تلقائية.</p>'}
            `;
            syncStatusContainer.className = 'bg-white p-4 rounded-xl shadow-md mb-6 border-l-4 border-green-500';
        } else {
            content = `
                <div class="flex items-center gap-3">
                  <i data-lucide="wifi-off" class="w-6 h-6 text-red-500"></i>
                  <div><p class="font-semibold text-red-600">غير متصل</p><p class="text-xs text-gray-500">سيتم الحفظ محلياً.</p></div>
                </div>
            `;
            syncStatusContainer.className = 'bg-white p-4 rounded-xl shadow-md mb-6 border-l-4 border-red-500';
        }
        syncStatusContainer.innerHTML = content + '<div id="pending-count-display" class="text-center"></div>';
        lucide.createIcons();
        updatePendingCount();
    }
    
    async function updatePendingCount() {
        const count = await db.collections.where('synced').equals(0).count();
        const display = document.getElementById('pending-count-display');
        if (display) {
            display.innerHTML = `<p class="text-sm font-medium">${count}</p><p class="text-xs text-gray-500">سجلات بانتظار المزامنة</p>`;
        }
    }

    function getOfflineLocation() {
        if (!navigator.geolocation) return alert('خاصية تحديد الموقع غير مدعومة.');
        locationBtnText.textContent = 'جاري...';
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                document.getElementById('gpsCoordinates').value = `${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
                locationBtnText.textContent = 'الموقع';
            },
            (err) => {
                alert('لا يمكن الحصول على الموقع الحالي.');
                locationBtnText.textContent = 'الموقع';
            },
            { enableHighAccuracy: true }
        );
    }
    
    // Start the app
    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>
