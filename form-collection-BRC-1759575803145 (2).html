
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>نموذج جمع ميداني (يعمل بدون انترنت)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: sans-serif; }
    .btn-primary { background-color: #2563eb; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
    .btn-primary:disabled { background-color: #93c5fd; cursor: not-allowed; }
    .btn-secondary { background-color: #4b5563; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s; }
    .btn-green { background-color: #16a34a; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
    .btn-green:disabled { background-color: #86efac; cursor: not-allowed; }
    .btn-red { background-color: #ef4444; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
    input, select, textarea { width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; border-radius: 0.5rem; background-color: #f9fafb; }
    label { font-weight: 500; margin-bottom: 0.25rem; display: block; }
  </style>
</head>
<body class="bg-gray-100">
  <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg my-8">
    <div class="flex justify-between items-start">
        <div>
            <h1 class="text-2xl font-bold mb-2">نموذج جمع ميداني (يعمل بدون انترنت)</h1>
            <p class="text-gray-600 mb-6">املأ الحقول واحفظ البيانات محلياً. عند توفر الإنترنت، قم بمزامنة البيانات.</p>
        </div>
        <div id="sync-status" class="text-sm font-medium text-gray-500"></div>
    </div>
    
    <div class="border-t pt-4 mb-6">
      <h2 class="text-lg font-semibold px-2 mb-4">المعلومات الأساسية</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div><label>رقم الباركود</label><input type="text" value="BRC-1759575803145" readonly class="bg-gray-200"></div>
        <div><label>نوع النبات</label><input type="text" value="زيتون" readonly class="bg-gray-200"></div>
        <div><label>الاسم العلمي</label><input type="text" value="olive" readonly class="bg-gray-200"></div>
      </div>
    </div>
    
    <form id="collectionForm">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div><label for="quantity">الكمية *</label><input id="quantity" name="quantity" type="number" value="1" required></div>
        <div><label for="unit">الوحدة *</label><select id="unit" name="unit" required><option>كيلو</option><option>جرام</option><option>قطعة</option></select></div>
        <div><label for="locationName">موقع الجمع *</label><input id="locationName" name="locationName" type="text" required></div>
        <div>
          <label for="gpsCoordinates">إحداثيات GPS *</label>
          <div class="flex gap-2">
            <input id="gpsCoordinates" name="gpsCoordinates" type="text" required>
            <button type="button" id="getLocationBtn" class="btn-secondary whitespace-nowrap">الموقع</button>
          </div>
        </div>
        <div><label for="collectionDate">تاريخ الجمع *</label><input id="collectionDate" name="collectionDate" type="date" value="2025-10-05" required></div>
        <div><label for="collectionTime">وقت الجمع *</label><input id="collectionTime" name="collectionTime" type="time" value="06:09" required></div>
        <div><label for="collectorName">اسم الجامع *</label><input id="collectorName" name="collectorName" type="text" required></div>
        <div><label for="notes">ملاحظات</label><textarea id="notes" name="notes" rows="3"></textarea></div>
      </div>
      <div class="mt-8 pt-6 border-t flex justify-end">
        <button type="submit" class="btn-primary">حفظ البيانات محلياً</button>
      </div>
    </form>
  </div>

  <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg my-8">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">السجلات المحفوظة محلياً</h2>
        <button id="syncBtn" class="btn-green">مزامنة البيانات مع الخادم</button>
    </div>
    <div id="records-list" class="space-y-3"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://taodxqtlkyhkupktliwv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhb2R4cXRsa3loa3Vwa3RsaXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxMDkxMjUsImV4cCI6MjA3NDY4NTEyNX0.3_Lolpx49GZJAai8I5qQRHpD8fXnuOGKJKEhHmXH9Ps';
    const form = document.getElementById('collectionForm');
    const recordsList = document.getElementById('records-list');
    const syncBtn = document.getElementById('syncBtn');
    const syncStatus = document.getElementById('sync-status');
    
    const getRecords = () => JSON.parse(localStorage.getItem('offlineCollections') || '[]');
    const saveRecords = (records) => localStorage.setItem('offlineCollections', JSON.stringify(records));

    function renderRecords() {
        const records = getRecords();
        recordsList.innerHTML = '';
        if (records.length === 0) {
            recordsList.innerHTML = '<p class="text-center text-gray-500 py-4">لا توجد سجلات محفوظة.</p>';
            return;
        }
        records.forEach(record => {
            const syncedText = record.synced ? 'تمت المزامنة' : 'لم تتم المزامنة';
            const syncedClass = record.synced ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
            const recordEl = document.createElement('div');
            recordEl.className = 'p-4 border rounded-lg flex justify-between items-center';
            recordEl.innerHTML = `
                <div>
                    <p class="font-bold">${record.plantName} - ${record.barcodeId}</p>
                    <p class="text-sm text-gray-600">الكمية: ${record.quantity} ${record.unit} | بتاريخ: ${record.collectionDate}</p>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-xs px-2 py-1 rounded-full ${syncedClass}">${syncedText}</span>
                    ${!record.synced ? `<button class="btn-red" onclick="deleteRecord('${record.localId}')">حذف</button>` : ''}
                </div>
            `;
            recordsList.appendChild(recordEl);
        });
    }

    window.deleteRecord = function(localId) {
        if (!confirm('هل أنت متأكد من حذف هذا السجل المحلي؟')) return;
        let records = getRecords();
        records = records.filter(r => r.localId !== localId);
        saveRecords(records);
        renderRecords();
    }

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        data.barcodeId = "BRC-1759575803145";
        data.plantName = "زيتون";
        data.scientificName = "olive";
        data.localId = 'local-' + Date.now();
        data.synced = false;

        const records = getRecords();
        records.push(data);
        saveRecords(records);

        alert('تم حفظ السجل محلياً بنجاح!');
        form.reset();
        document.getElementById('collectionDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('collectionTime').value = new Date().toTimeString().split(' ')[0].substring(0,5);
        renderRecords();
    });

    syncBtn.addEventListener('click', async () => {
        const records = getRecords();
        const unsyncedRecords = records.filter(r => !r.synced);

        if (unsyncedRecords.length === 0) {
            syncStatus.textContent = 'لا توجد بيانات للمزامنة';
            setTimeout(() => syncStatus.textContent = '', 3000);
            return;
        }

        if (!navigator.onLine) {
            syncStatus.textContent = 'أنت غير متصل بالإنترنت!';
            syncStatus.style.color = 'red';
            setTimeout(() => { syncStatus.textContent = ''; syncStatus.style.color = ''; }, 3000);
            return;
        }

        syncBtn.disabled = true;
        syncBtn.textContent = 'جاري المزامنة...';
        syncStatus.textContent = 'جاري المزامنة...';
        syncStatus.style.color = 'orange';

        let successCount = 0;
        for (const record of unsyncedRecords) {
            const supabaseRecord = {
                barcode_id: record.barcodeId,
                plant_type: record.plantName,
                scientific_name: record.scientificName,
                location: `${record.locationName} (${record.gpsCoordinates})`,
                collection_date: record.collectionDate,
                collection_time: record.collectionTime,
                quantity: record.quantity,
                unit: record.unit,
                quality: 'جيد', // Default, as it's not in the simple form
                collector: record.collectorName,
                notes: record.notes,
                status: 'قيد المعالجة'
            };
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/seed_collections`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(supabaseRecord)
                });

                if (!response.ok) {
                    throw new Error(`Failed to sync record ${record.barcodeId}: ${response.statusText}`);
                }
                
                const originalRecord = records.find(r => r.localId === record.localId);
                if (originalRecord) {
                    originalRecord.synced = true;
                }
                successCount++;

            } catch (error) {
                console.error(error);
                syncStatus.textContent = `فشل مزامنة بعض السجلات. ${error.message}`;
                syncStatus.style.color = 'red';
                // Stop on first error to avoid data issues
                break; 
            }
        }

        saveRecords(records);
        renderRecords();
        
        if (successCount === unsyncedRecords.length) {
            syncStatus.textContent = 'تمت المزامنة بنجاح!';
            syncStatus.style.color = 'green';
        }

        setTimeout(() => { syncStatus.textContent = ''; syncStatus.style.color = ''; }, 5000);
        syncBtn.disabled = false;
        syncBtn.textContent = 'مزامنة البيانات مع الخادم';
    });

    document.getElementById('getLocationBtn').addEventListener('click', () => {
        const gpsInput = document.getElementById('gpsCoordinates');
        if (!navigator.geolocation) {
            alert('خاصية تحديد الموقع غير مدعومة.');
            return;
        }
        document.getElementById('getLocationBtn').textContent = 'جاري...';
        navigator.geolocation.getCurrentPosition(
            (position) => {
                gpsInput.value = position.coords.latitude.toFixed(5) + ', ' + position.coords.longitude.toFixed(5);
                document.getElementById('getLocationBtn').textContent = 'الموقع';
            },
            (error) => {
                alert('فشل الحصول على الموقع. يرجى إدخاله يدوياً.');
                document.getElementById('getLocationBtn').textContent = 'الموقع';
            },
            { enableHighAccuracy: true }
        );
    });

    // Initial render
    renderRecords();
  </script>
</body>
</html>
    
